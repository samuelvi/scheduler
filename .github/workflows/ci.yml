name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  tests:
    name: Tests (PHP 8.4)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services
        run: |
          docker compose -f docker/docker-compose.yml up -d
          sleep 10

      - name: Check running containers
        run: docker compose -f docker/docker-compose.yml ps

      - name: Install dependencies
        run: docker compose -f docker/docker-compose.yml exec -T php composer install --prefer-dist --no-progress --no-interaction

      - name: Wait for database
        run: |
          timeout 30 bash -c 'until docker compose -f docker/docker-compose.yml exec -T postgres pg_isready -U symfony; do sleep 1; done'

      - name: Create database
        run: docker compose -f docker/docker-compose.yml exec -T php bin/console doctrine:database:create --if-not-exists --no-interaction

      - name: Run migrations
        run: docker compose -f docker/docker-compose.yml exec -T php bin/console doctrine:migrations:migrate --no-interaction

      - name: Run Unit Tests
        run: docker compose -f docker/docker-compose.yml exec -T php vendor/bin/phpunit --testsuite=Unit --colors=never

      - name: Run Integration Tests
        run: docker compose -f docker/docker-compose.yml exec -T php vendor/bin/phpunit --testsuite=Integration --colors=never

      - name: Run Functional Tests
        run: docker compose -f docker/docker-compose.yml exec -T php vendor/bin/phpunit --testsuite=Functional --colors=never

      - name: Show logs on failure
        if: failure()
        run: docker compose -f docker/docker-compose.yml logs

      - name: Stop services
        if: always()
        run: docker compose -f docker/docker-compose.yml down -v

  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services
        run: |
          docker compose -f docker/docker-compose.yml up -d
          sleep 10

      - name: Install dependencies
        run: docker compose -f docker/docker-compose.yml exec -T php composer install --prefer-dist --no-progress --no-interaction

      - name: Wait for database
        run: |
          timeout 30 bash -c 'until docker compose -f docker/docker-compose.yml exec -T postgres pg_isready -U symfony; do sleep 1; done'

      - name: Create database
        run: docker compose -f docker/docker-compose.yml exec -T php bin/console doctrine:database:create --if-not-exists --no-interaction

      - name: Run migrations
        run: docker compose -f docker/docker-compose.yml exec -T php bin/console doctrine:migrations:migrate --no-interaction

      - name: Run benchmark (1000 tasks)
        run: docker compose -f docker/docker-compose.yml exec -T php bin/console app:benchmark-scheduler --tasks=1000 --clean

      - name: Show scheduler stats
        run: docker compose -f docker/docker-compose.yml exec -T php bin/console app:scheduler:stats

      - name: Stop services
        if: always()
        run: docker compose -f docker/docker-compose.yml down -v

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start PHP service
        run: |
          docker compose -f docker/docker-compose.yml up -d php
          sleep 5

      - name: Install dependencies
        run: docker compose -f docker/docker-compose.yml exec -T php composer install --prefer-dist --no-progress --no-interaction

      - name: Check PHP syntax
        run: docker compose -f docker/docker-compose.yml exec -T php find src tests -name "*.php" -exec php -l {} \;

      # Uncomment when PHP-CS-Fixer is installed
      # - name: Check coding standards
      #   run: docker compose -f docker/docker-compose.yml exec -T php vendor/bin/php-cs-fixer fix --dry-run --diff

      # Uncomment when PHPStan is installed
      # - name: Run static analysis
      #   run: docker compose -f docker/docker-compose.yml exec -T php vendor/bin/phpstan analyse src --level=8

      - name: Stop services
        if: always()
        run: docker compose -f docker/docker-compose.yml down -v
